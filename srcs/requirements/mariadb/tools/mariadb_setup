#!/bin/sh

set -xe

# Change ownership of the MySQL data directory
chown -R mysql:mysql /var/lib/mysql

if [ ! -d "/var/lib/mysql/${MARIADB_DATABASE}" ]; then
	service mysql start

	mysql -e "CREATE DATABASE IF NOT EXISTS ${MARIADB_DATABASE}; \
      GRANT ALL ON *.* TO '${MARIADB_ROOT_USER}'@'localhost' IDENTIFIED BY '${MARIADB_ROOT_PASSWORD}' WITH GRANT OPTION; \
	  CREATE USER '${MARIADB_ROOT_USER}'@'%' IDENTIFIED BY '${MARIADB_ROOT_PASSWORD}'; \
	  GRANT ALL ON *.* TO '${MARIADB_ROOT_USER}'@'%' IDENTIFIED BY '${MARIADB_ROOT_PASSWORD}' WITH GRANT OPTION; \
	  FLUSH PRIVILEGES; \
	  CREATE USER '${MARIADB_USER}'@'localhost' IDENTIFIED BY '${MARIADB_PASSWORD}'; \
	  CREATE USER '${MARIADB_USER}'@'%' IDENTIFIED BY '${MARIADB_PASSWORD}'; \
	  GRANT ALL PRIVILEGES ON *.* TO '${MARIADB_USER}'@'localhost'; \
	  GRANT ALL PRIVILEGES ON *.* TO '${MARIADB_USER}'@'%'; \
	  FLUSH PRIVILEGES;"

	mysql -u"$MARIADB_ROOT_USER" -D"$MARIADB_DATABASE" < /tmp/dump.sql
	service mysql stop

	mysqladmin -u"$MARIADB_ROOT_USER" -p"$MARIADB_ROOT_PASSWORD" shutdown
fi

/usr/bin/mysqld_safe
